<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <!-- Mobile optimization -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">

  <!-- Enhanced SEO Meta Tags -->
  <meta name="description" content="Chat with Wataru, a friendly AI assistant providing instant text and media responses. Enjoy a professional, modern interface that supports images, videos, audio, and files." />
  <meta name="keywords" content="AI, Chatbot, Wataru, Assistant, Image, Video, Audio, File, Bot" />
  <meta name="robots" content="index, follow" />
  <meta name="author" content="Wataru" />
  <link rel="canonical" href="https://wataru-chat.com/" />
  <meta property="og:title" content="Wataru Chat Assistant" />
  <meta property="og:description" content="Chat with Wataru, a friendly AI assistant providing instant text and media responses." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://wataru-chat.com/" />
  <meta property="og:image" content="https://wataru-chat.com/og-image.jpg" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="theme-color" content="#2563eb" />

  <title>Wataru Chat Assistant</title>

  <!-- Favicon -->
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <link rel="manifest" href="manifest.json">

  <!-- Preload Critical Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: {
              DEFAULT: '#2563eb',
              50: '#eff6ff',
              100: '#dbeafe',
              200: '#bfdbfe',
              300: '#93c5fd',
              400: '#60a5fa',
              500: '#3b82f6',
              600: '#2563eb',
              700: '#1d4ed8',
              800: '#1e40af',
              900: '#1e3a8a',
              950: '#172554',
            },
            dark: {
              bg: '#121212',
              card: '#1e1e1e',
              input: '#2a2a2a',
              border: '#333333',
              text: '#e4e6eb',
              secondary: '#b0b3b8',
            },
          },
          animation: {
            'bounce-slow': 'bounce 1.5s infinite',
          },
          boxShadow: {
            'message': '0 2px 5px rgba(0, 0, 0, 0.1)',
            'message-light': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
            'card-light': '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)',
            'dropdown-light': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
            'input-focus': '0 0 0 3px rgba(59, 130, 246, 0.3)',
          },
        },
        fontFamily: {
          sans: ['Inter', 'system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'],
        },
      },
    }
  </script>

  <!-- Fix for mobile browsers with dynamic toolbars (e.g. Brave on mobile) -->
  <script>
    function setViewportProperty() {
      let vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty('--vh', `${vh}px`);
    }
    window.addEventListener('resize', setViewportProperty);
    setViewportProperty();
  </script>

  <style>
    /* Hide scrollbars visually */
    @layer utilities {
      .scrollbar-hide::-webkit-scrollbar { display: none; }
      .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    }
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background-color: rgba(156, 163, 175, 0.5);
      border-radius: 3px;
    }
    .dark .custom-scrollbar::-webkit-scrollbar-thumb {
      background-color: rgba(75, 85, 99, 0.5);
    }
    /* Message styling */
    .message-text { white-space: pre-wrap; word-break: break-word; }
    .media-message img, .media-message video {
      max-width: 100%; border-radius: 0.75rem; margin: 0.5rem 0;
    }
    .media-message audio { width: 100%; margin: 0.5rem 0; }
    .message-bubble {
      max-width: 80%; 
      transition: all 0.2s ease;
    }
    .message-bubble:hover { transform: translateY(-1px); }
    .user-message { 
      background-color: #2563eb; 
      color: white; 
      border-radius: 18px 18px 4px 18px; 
      box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2), 0 2px 4px -1px rgba(37, 99, 235, 0.1);
    }
    .dark .user-message { 
      background-color: #3b82f6; 
      box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3), 0 2px 4px -1px rgba(59, 130, 246, 0.2);
    }
    .bot-message { 
      background-color: #f3f4f6; 
      color: #1f2937; 
      border-radius: 18px 18px 18px 4px; 
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
    }
    .dark .bot-message { 
      background-color: #2a2a2a; 
      color: #e4e6eb; 
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.1);
    }
    /* Animations */
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .message-animation { animation: slideIn 0.3s ease, fadeIn 0.3s ease; }
    /* Image lightbox */
    .lightbox {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.9); display: flex;
      justify-content: center; align-items: center; z-index: 1000;
      opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
      backdrop-filter: blur(5px);
    }
    .lightbox.active { opacity: 1; pointer-events: auto; }
    .lightbox img { 
      max-width: 90%; max-height: 90%; object-fit: contain; 
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
      border-radius: 8px;
    }
    .lightbox-close {
      position: absolute; top: 20px; right: 20px; color: white;
      font-size: 30px; cursor: pointer;
      width: 40px; height: 40px;
      display: flex; align-items: center; justify-content: center;
      background-color: rgba(0, 0, 0, 0.5);
      border-radius: 50%;
      transition: background-color 0.2s ease;
    }
    .lightbox-close:hover {
      background-color: rgba(0, 0, 0, 0.8);
    }
    /* Form styling */
    .form-input {
      width: 100%;
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      border: 1px solid #e5e7eb;
      background-color: #f9fafb;
      color: #1f2937;
      transition: all 0.2s ease;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }
    .dark .form-input {
      border-color: #374151;
      background-color: #1f2937;
      color: #f9fafb;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }
    .form-input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
    }
    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: #4b5563;
    }
    .dark .form-label {
      color: #d1d5db;
    }
    .auth-card {
      background-color: white;
      border-radius: 1rem;
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      width: 100%;
      max-width: 400px;
      padding: 2rem;
      transition: all 0.3s ease;
    }
    .dark .auth-card {
      background-color: #1f2937;
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
    }
    .auth-button {
      width: 100%;
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      background-color: #2563eb;
      color: white;
      font-weight: 500;
      transition: all 0.2s ease;
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2), 0 2px 4px -1px rgba(37, 99, 235, 0.1);
    }
    .auth-button:hover {
      background-color: #1d4ed8;
      transform: translateY(-1px);
      box-shadow: 0 6px 8px -1px rgba(37, 99, 235, 0.2), 0 3px 5px -1px rgba(37, 99, 235, 0.1);
    }
    .auth-button:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
    }
    .auth-button:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
      box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.1), 0 2px 4px -1px rgba(37, 99, 235, 0.05);
    }
    .social-button {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      background-color: white;
      color: #1f2937;
      font-weight: 500;
      transition: all 0.2s ease;
      border: 1px solid #e5e7eb;
      cursor: pointer;
      margin-bottom: 0.75rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    .dark .social-button {
      background-color: #1f2937;
      color: #f9fafb;
      border-color: #374151;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }
    .social-button:hover {
      background-color: #f9fafb;
      transform: translateY(-1px);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
    }
    .dark .social-button:hover {
      background-color: #374151;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    .social-button svg {
      margin-right: 0.75rem;
    }
    .auth-divider {
      display: flex;
      align-items: center;
      margin: 1.5rem 0;
    }
    .auth-divider::before, .auth-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background-color: #e5e7eb;
    }
    .dark .auth-divider::before, .dark .auth-divider::after {
      background-color: #374151;
    }
    .auth-divider-text {
      padding: 0 1rem;
      color: #6b7280;
    }
    .dark .auth-divider-text {
      color: #9ca3af;
    }
    .auth-error {
      background-color: #fee2e2;
      color: #b91c1c;
      padding: 0.75rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      box-shadow: 0 1px 3px rgba(185, 28, 28, 0.1);
    }
    .dark .auth-error {
      background-color: rgba(185, 28, 28, 0.2);
      color: #fca5a5;
      box-shadow: 0 1px 3px rgba(185, 28, 28, 0.2);
    }
    .auth-error svg {
      margin-right: 0.5rem;
      flex-shrink: 0;
    }
    .auth-success {
      background-color: #d1fae5;
      color: #047857;
      padding: 0.75rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      box-shadow: 0 1px 3px rgba(4, 120, 87, 0.1);
    }
    .dark .auth-success {
      background-color: rgba(4, 120, 87, 0.2);
      color: #6ee7b7;
      box-shadow: 0 1px 3px rgba(4, 120, 87, 0.2);
    }
    .auth-success svg {
      margin-right: 0.5rem;
      flex-shrink: 0;
    }
    .password-input-wrapper {
      position: relative;
    }
    .password-toggle {
      position: absolute;
      right: 1rem;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      color: #6b7280;
      background: none;
      border: none;
      padding: 0;
      transition: color 0.2s ease;
    }
    .password-toggle:hover {
      color: #4b5563;
    }
    .dark .password-toggle {
      color: #9ca3af;
    }
    .dark .password-toggle:hover {
      color: #d1d5db;
    }
    /* Drop-down menu styling */
    .dropdown-menu {
      position: absolute;
      right: 0;
      top: 110%;
      margin-top: 0.5rem;
      width: 12rem;
      background-color: white;
      border-radius: 0.375rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      z-index: 50;
      opacity: 0;
      transform: scale(0.95);
      pointer-events: none;
      transition: opacity 150ms ease, transform 150ms ease;
      border: 1px solid rgba(0, 0, 0, 0.05);
    }
    .dark .dropdown-menu {
      background-color: #1f2937;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }
    .dropdown-menu.show {
      opacity: 1;
      transform: scale(1);
      pointer-events: auto;
    }
    .dropdown-menu button {
      width: 100%;
      text-align: left;
      padding: 0.75rem 1rem;
      color: #374151;
      background: none;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: background-color 0.2s ease, color 0.2s ease;
    }
    .dark .dropdown-menu button {
      color: #d1d5db;
    }
    .dropdown-menu button:hover {
      background-color: #f3f4f6;
      color: #111827;
    }
    .dark .dropdown-menu button:hover {
      background-color: #374151;
      color: #f9fafb;
    }

    /* Enhanced header shadow for light mode */
    #chat-header {
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      position: sticky;
      top: 0;
      z-index: 30;
      padding-top: env(safe-area-inset-top);
    }

    .dark #chat-header {
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.15);
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      padding-top: env(safe-area-inset-top);
    }

    /* Sticky footer with enhanced shadow */
    footer {
      position: sticky;
      bottom: 0;
      z-index: 20;
      padding-bottom: env(safe-area-inset-bottom);
      box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1), 0 -2px 4px -1px rgba(0, 0, 0, 0.06);
      border-top: 1px solid rgba(0, 0, 0, 0.05);
    }

    .dark footer {
      box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.2), 0 -2px 4px -1px rgba(0, 0, 0, 0.15);
      border-top: 1px solid rgba(255, 255, 255, 0.05);
    }

    /* Ensure chat area scrolls properly with fixed header and footer */
    #chat {
      overflow-y: auto;
      scroll-padding-top: 4rem;
      scroll-padding-bottom: 4rem;
    }

    /* Focus styles for accessibility */
    a:focus, button:focus, input:focus, textarea:focus {
      outline: 2px solid #3b82f6;
      outline-offset: 2px;
    }
    .dark a:focus, .dark button:focus, .dark input:focus, .dark textarea:focus {
      outline-color: #60a5fa;
    }
    /* Skip to content link for accessibility */
    .skip-link {
      position: absolute;
      top: -40px;
      left: 0;
      background: #2563eb;
      color: white;
      padding: 8px;
      z-index: 100;
      transition: top 0.3s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .skip-link:focus {
      top: 0;
    }
    /* Reduced motion preference */
    @media (prefers-reduced-motion: reduce) {
      *, ::before, ::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
      }
      .message-animation {
        animation: none !important;
      }
    }
    /* Material Design inspired ripple effect */
    .ripple {
      position: relative;
      overflow: hidden;
    }
    .ripple:after {
      content: "";
      display: block;
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      pointer-events: none;
      background-image: radial-gradient(circle, #fff 10%, transparent 10.01%);
      background-repeat: no-repeat;
      background-position: 50%;
      transform: scale(10, 10);
      opacity: 0;
      transition: transform .5s, opacity 1s;
    }
    .ripple:active:after {
      transform: scale(0, 0);
      opacity: .3;
      transition: 0s;
    }
    .dark .ripple:after {
      background-image: radial-gradient(circle, rgba(255, 255, 255, 0.3) 10%, transparent 10.01%);
    }
    /* Enhanced input field */
    #command-input {
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      transition: box-shadow 0.2s ease, background-color 0.2s ease;
    }
    #command-input:focus {
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05), 0 0 0 3px rgba(59, 130, 246, 0.3);
    }
    .dark #command-input {
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    .dark #command-input:focus {
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2), 0 0 0 3px rgba(59, 130, 246, 0.3);
    }
    /* Enhanced send button */
    #send-command {
      transition: transform 0.2s ease, background-color 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    #send-command:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }
    #send-command:active {
      transform: translateY(0);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }
    .dark #send-command {
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    .dark #send-command:hover {
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    }
    .dark #send-command:active {
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }
    /* Google Material Design inspired elevation */
    .elevation-1 {
      box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
    }
    .elevation-2 {
      box-shadow: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
    }
    .elevation-3 {
      box-shadow: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23);
    }
    .dark .elevation-1 {
      box-shadow: 0 1px 3px rgba(0,0,0,0.24), 0 1px 2px rgba(0,0,0,0.36);
    }
    .dark .elevation-2 {
      box-shadow: 0 3px 6px rgba(0,0,0,0.28), 0 3px 6px rgba(0,0,0,0.35);
    }
    .dark .elevation-3 {
      box-shadow: 0 10px 20px rgba(0,0,0,0.33), 0 6px 6px rgba(0,0,0,0.35);
    }
  </style>
</head>

<!-- Using inline style with the CSS variable to fix mobile viewport height -->
<body style="height: calc(var(--vh, 1vh) * 100);" class="bg-gray-50 text-gray-900 antialiased dark:bg-dark-bg dark:text-dark-text">
  <!-- Skip to content link for accessibility -->
  <a href="#chat" class="skip-link">Skip to chat</a>

  <!-- Login Container -->
  <div id="login-container" class="fixed inset-0 flex items-center justify-center p-4 bg-black bg-opacity-50 backdrop-blur-sm z-50" role="dialog" aria-labelledby="login-title" aria-modal="true">
    <div class="auth-card elevation-3">
      <div class="text-center mb-6">
        <h2 id="login-title" class="text-2xl font-bold text-gray-900 dark:text-white">Welcome back</h2>
        <p class="text-gray-600 dark:text-gray-400 mt-1">Sign in to your account to continue</p>
      </div>

      <div id="login-error" class="auth-error hidden" role="alert">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
        </svg>
        <span>Invalid username or password</span>
      </div>

      <form id="login-form" class="space-y-4">
        <div>
          <label for="username" class="form-label">Username</label>
          <input type="text" id="username" class="form-input" placeholder="Enter your username" required autocomplete="username">
        </div>

        <div>
          <label for="password" class="form-label">Password</label>
          <div class="password-input-wrapper">
            <input type="password" id="password" class="form-input" placeholder="Enter your password" required autocomplete="current-password">
            <button type="button" class="password-toggle" aria-label="Toggle password visibility">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
              </svg>
            </button>
          </div>
        </div>

        <button type="submit" class="auth-button ripple">
          <span id="login-button-text">Sign in</span>
          <span id="login-button-loading" class="hidden">
            <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" aria-hidden="true">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Signing in...
          </span>
        </button>
      </form>

      <div class="auth-divider">
        <span class="auth-divider-text">or</span>
      </div>

      <p class="text-center text-gray-600 dark:text-gray-400 mt-6">
        Don't have an account? 
        <a href="#" id="show-create-account" class="text-primary-600 dark:text-primary-400 hover:underline focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-opacity-50 rounded font-medium">
          Create one
        </a>
      </p>
    </div>
  </div>

  <!-- Create Account Container -->
  <div id="create-account-container" class="fixed inset-0 flex items-center justify-center p-4 bg-black bg-opacity-50 backdrop-blur-sm z-50 hidden" role="dialog" aria-labelledby="create-account-title" aria-modal="true">
    <div class="auth-card elevation-3">
      <div class="text-center mb-6">
        <h2 id="create-account-title" class="text-2xl font-bold text-gray-900 dark:text-white">Create an account</h2>
        <p class="text-gray-600 dark:text-gray-400 mt-1">Join Wataru Chat today</p>
      </div>

      <div id="create-account-error" class="auth-error hidden" role="alert">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
        </svg>
        <span>Account creation failed</span>
      </div>

      <div id="create-account-success" class="auth-success hidden" role="alert">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
        </svg>
        <span>Account created successfully! Signing you in...</span>
      </div>

      <form id="create-account-form" class="space-y-4">
        <div>
          <label for="new-username" class="form-label">Username</label>
          <input type="text" id="new-username" class="form-input" placeholder="Choose a username" required autocomplete="username">
        </div>

        <div>
          <label for="new-email" class="form-label">Email (optional)</label>
          <input type="email" id="new-email" class="form-input" placeholder="Enter your email" autocomplete="email">
        </div>

        <div>
          <label for="new-password" class="form-label">Password</label>
          <div class="password-input-wrapper">
            <input type="password" id="new-password" class="form-input" placeholder="Create a password" required autocomplete="new-password" minlength="6" aria-describedby="password-requirements">
            <button type="button" class="password-toggle" aria-label="Toggle password visibility">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
              </svg>
            </button>
          </div>
          <p id="password-requirements" class="text-xs text-gray-500 dark:text-gray-400 mt-1">Password must be at least 6 characters</p>
        </div>

        <button type="submit" class="auth-button ripple">
          <span id="create-button-text">Create account</span>
          <span id="create-button-loading" class="hidden">
            <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" aria-hidden="true">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Creating account...
          </span>
        </button>
      </form>

      <div class="auth-divider">
        <span class="auth-divider-text">or</span>
      </div>

      <p class="text-center text-gray-600 dark:text-gray-400 mt-6">
        Already have an account? 
        <a href="#" id="show-login" class="text-primary-600 dark:text-primary-400 hover:underline focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-opacity-50 rounded font-medium">
          Sign in
        </a>
      </p>
    </div>
  </div>

  <!-- Header for Chat (visible after login) -->
  <header id="chat-header" class="hidden bg-white dark:bg-dark-card h-16 flex items-center justify-between px-4 relative">
    <div class="flex items-center">
      <img src="https://i.imgur.com/xwCoQ5H.jpeg" alt="Wataru Profile" class="h-10 w-10 mr-3 rounded-full object-cover border-2 border-primary-300 dark:border-primary-700" loading="lazy" />
      <div>
        <h1 class="text-gray-900 dark:text-dark-text font-semibold">Wataru</h1>
        <div class="flex items-center">
          <span class="w-2 h-2 bg-green-500 rounded-full mr-2" aria-hidden="true"></span>
          <p class="text-gray-500 dark:text-dark-secondary text-xs">Active Now</p>
        </div>
      </div>
    </div>
    <!-- Professional Drop-down Menu -->
    <div class="relative">
      <button id="menu-button" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-dark-input focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-opacity-50 ripple" aria-label="Open menu" aria-haspopup="true" aria-expanded="false">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600 dark:text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
      <div id="dropdown-menu" class="dropdown-menu" role="menu" aria-orientation="vertical" aria-labelledby="menu-button">
        <button id="theme-toggle-menu" role="menuitem">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
          </svg>
          Toggle Theme
        </button>
        <button id="clear-chat-menu" role="menuitem">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5-4h4m-4 0a1 1 0 00-1 1v1h6V4a1 1 0 00-1-1m-4 0h4" />
          </svg>
          Clear Chat
        </button>
        <button id="logout-menu" role="menuitem">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
          </svg>
          Logout
        </button>
      </div>
    </div>
  </header>

  <!-- Chat Container (visible after login) -->
  <div id="chat-container" class="hidden flex-1 flex flex-col main-content relative h-full">
    <!-- Chat Area -->
    <main id="chat" class="flex-1 overflow-y-auto p-4 custom-scrollbar space-y-4 bg-gray-50 dark:bg-dark-bg" aria-label="Chat area">
      <!-- Chat messages appended via JS -->
    </main>

    <!-- Footer - Now explicitly sticky with enhanced shadow -->
    <footer class="bg-white dark:bg-dark-card px-4 py-3 border-t border-gray-200 dark:border-dark-border">
      <div class="max-w-3xl mx-auto flex items-end">
        <textarea id="command-input" rows="1" placeholder="Type a message..." class="flex-1 bg-gray-100 dark:bg-dark-input text-gray-900 dark:text-dark-text border-none rounded-full py-2 px-4 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-opacity-50 resize-none custom-scrollbar transition-shadow duration-200" aria-label="Type a message"></textarea>
        <button id="send-command" class="ml-2 p-2 rounded-full text-primary-600 dark:text-primary-400 hover:bg-gray-100 dark:hover:bg-dark-input focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-opacity-50 transition-all duration-200 ease-in-out hidden ripple" aria-label="Send message">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6" aria-hidden="true">
            <path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z"/>
          </svg>
        </button>
      </div>
    </footer>
  </div>

  <!-- Image Lightbox -->
  <div id="lightbox" class="lightbox" role="dialog" aria-modal="true" aria-label="Image preview">
    <button class="lightbox-close" id="lightbox-close" aria-label="Close image preview">&times;</button>
    <img id="lightbox-img" src="/placeholder.svg" alt="Enlarged image">
  </div>

  <!-- Connection Status Banner -->
  <div id="connection-status" class="fixed top-0 left-0 right-0 bg-red-500 text-white text-center py-2 transform -translate-y-full transition-transform duration-300 z-50 elevation-2" role="alert">
    You're offline. Please check your internet connection.
  </div>

  <!-- Axios -->
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <!-- Main JS -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // Chat interface elements
      const chatContainer = document.getElementById("chat-container");
      const chatHeader = document.getElementById("chat-header");
      const commandInput = document.getElementById("command-input");
      const sendCommandButton = document.getElementById("send-command");
      const chatArea = document.getElementById("chat");
      const lightbox = document.getElementById("lightbox");
      const lightboxImg = document.getElementById("lightbox-img");
      const lightboxClose = document.getElementById("lightbox-close");
      const connectionStatus = document.getElementById("connection-status");

      // Login / Create Account elements
      const loginContainer = document.getElementById("login-container");
      const loginForm = document.getElementById("login-form");
      const loginError = document.getElementById("login-error");
      const loginButtonText = document.getElementById("login-button-text");
      const loginButtonLoading = document.getElementById("login-button-loading");
      const usernameInput = document.getElementById("username");
      const passwordInput = document.getElementById("password");
      const createAccountContainer = document.getElementById("create-account-container");
      const createAccountForm = document.getElementById("create-account-form");
      const createAccountError = document.getElementById("create-account-error");
      const createAccountSuccess = document.getElementById("create-account-success");
      const createButtonText = document.getElementById("create-button-text");
      const createButtonLoading = document.getElementById("create-button-loading");
      const newUsernameInput = document.getElementById("new-username");
      const newPasswordInput = document.getElementById("new-password");
      const newEmailInput = document.getElementById("new-email");
      const showCreateAccountLink = document.getElementById("show-create-account");
      const showLoginLink = document.getElementById("show-login");

      // Drop-down menu elements      const menuButton = document.getElementById("menu-button");
      const dropdownMenu = document.getElementById("dropdown-menu");
      const themeToggleMenu = document.getElementById("theme-toggle-menu");
      const clearChatMenu = document.getElementById("clear-chat-menu");
      const logoutMenu = document.getElementById("logout-menu");

      // Global state for chat history per login session
      let conversationId = "";  // will be set to the user session token upon login
      let chatHistoryKey = "";

      /* ---------------------------
       * Theme Management
       * --------------------------- */
      const initTheme = () => {
        const savedTheme = localStorage.getItem("theme");
        const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
        if (savedTheme === "dark" || (!savedTheme && prefersDark)) {
          document.documentElement.classList.add("dark");
          updateThemeToggleText();
        }
      };

      const toggleTheme = () => {
        if (document.documentElement.classList.contains("dark")) {
          document.documentElement.classList.remove("dark");
          localStorage.setItem("theme", "light");
        } else {
          document.documentElement.classList.add("dark");
          localStorage.setItem("theme", "dark");
        }
        updateThemeToggleText();
      };

      const updateThemeToggleText = () => {
        if (document.documentElement.classList.contains("dark")) {
          themeToggleMenu.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
            </svg>
            Light Mode`;
        } else {
          themeToggleMenu.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
            </svg>
            Dark Mode`;
        }
      };

      /* ---------------------------
       * Utility & Chat Functions
       * --------------------------- */
      const scrollToBottom = () => {
        requestAnimationFrame(() => {
          chatArea.scrollTo({ top: chatArea.scrollHeight, behavior: "smooth" });
        });
      };

      // Expanded media regex including additional image, audio, video, and document extensions
      const mediaRegex = /(https?:\/\/[^\s]+?\.(?:jpg|jpeg|png|gif|svg|webp|bmp|mp4|webm|ogg|mp3|wav|flac|aac|pdf|doc|docx|xls|xlsx|ppt|pptx)(?:[\?#]\S*)?)/gi;

      const addMessage = (content, isUser = false, saveToHistory = true) => {
        const messageDiv = document.createElement("div");
        messageDiv.className = `flex ${isUser ? "justify-end" : "justify-start"} message-animation`;
        messageDiv.dataset.messageId = Date.now().toString();
        messageDiv.setAttribute("role", "listitem");

        let messageContent;
        if (typeof content === "object" && content.type) {
          if (content.type === "reply") {
            messageContent = document.createElement("div");
            messageContent.className = "p-3 rounded-lg bot-message message-bubble message-text max-w-[80%] shadow-message";
            messageContent.innerHTML = processContent(content.args && content.args[0] ? content.args[0] : "");
          } else {
            messageContent = document.createElement("div");
            messageContent.className = "media-message p-3 rounded-lg bot-message message-bubble max-w-[80%] shadow-message";
            messageContent.innerHTML = createMediaElement(content);
          }
        } else {
          messageContent = document.createElement("div");
          messageContent.className = `p-3 rounded-lg ${isUser ? "user-message" : "bot-message"} message-bubble message-text max-w-[80%] shadow-message`;
          messageContent.innerHTML = processContent(content);
        }

        messageDiv.appendChild(messageContent);
        chatArea.appendChild(messageDiv);
        scrollToBottom();

        if (saveToHistory) saveMessageToHistory(content, isUser);

        // Enable lightbox for images.
        const images = messageContent.querySelectorAll('img:not([role="presentation"])');
        images.forEach(img => {
          img.style.cursor = 'pointer';
          img.addEventListener('click', () => openLightbox(img.src));
          if (!img.alt || img.alt === "") {
            img.alt = "Chat image";
          }
          // Add error handling for images
          img.onerror = function() {
            this.onerror = null;
            this.src = '/placeholder.svg';
            this.alt = 'Image failed to load';
          };
        });

        if (!isUser) {
          announceToScreenReader(`New message: ${typeof content === 'string' ? content : 'Media content'}`);
        }
      };

      const announceToScreenReader = (message) => {
        const announcement = document.createElement('div');
        announcement.setAttribute('aria-live', 'polite');
        announcement.classList.add('sr-only');
        announcement.textContent = message;
        document.body.appendChild(announcement);
        setTimeout(() => {
          document.body.removeChild(announcement);
        }, 1000);
      };

      const processLongWords = (text) => {
        return text.split(" ").map(word => word.length > 30 ? `<span class="break-all">${word}</span>` : word).join(" ");
      };

      const processContent = (content) => {
        if (typeof content === "object" && content.type && content.type !== "reply") return "";
        if (!content) return "";
        content = String(content)
          .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
          .replace(/\*(.*?)\*/g, "<em>$1</em>")
          .replace(/~~(.*?)~~/g, "<del>$1</del>")
          .replace(/`(.*?)`/g, "<code class='bg-gray-100 dark:bg-dark-input px-1 py-0.5 rounded text-sm'>$1</code>")
          .replace(/\n/g, "<br>");
        content = processLongWords(content);
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        content = content.replace(urlRegex, (url) => {
          try {
            const parsedUrl = new URL(url);
            return `<a href="${url}" target="_blank" rel="noopener noreferrer" class="text-primary-600 dark:text-primary-400 hover:underline">
              ${parsedUrl.hostname}${parsedUrl.pathname.length > 1 ? parsedUrl.pathname : ''}
              <span class="sr-only">(opens in new tab)</span>
            </a>`;
          } catch { return url; }
        });
        content = content.replace(mediaRegex, (match) => {
          try {
            const parsed = new URL(match);
            parsed.search = "";
            const cleanUrl = parsed.toString();
            const ext = parsed.pathname.split(".").pop().toLowerCase();
            if (/(jpg|jpeg|png|gif|svg|webp|bmp)/.test(ext)) {
              return createMediaElement({ type: "photo", args: [cleanUrl] });
            } else if (/(mp4|webm|ogg)/.test(ext)) {
              return createMediaElement({ type: "video", args: [cleanUrl] });
            } else if (/(mp3|wav|flac|aac)/.test(ext)) {
              return createMediaElement({ type: "audio", args: [cleanUrl] });
            } else if (/(pdf|doc|docx|xls|xlsx|ppt|pptx)/.test(ext)) {
              return createMediaElement({ type: "document", args: [cleanUrl] });
            }
          } catch { return `<span class="break-all">${match}</span>`; }
          return `<span class="break-all">${match}</span>`;
        });
        return content;
      };

      // Updated to support both "photo" and "waifu" as image types
      const createMediaElement = (media) => {
        let mediaElement = "";
        const mediaUrl = (media.args && media.args[0]) || media.photo || media.video || media.audio || media.document || "";
        if (!mediaUrl) return '<span class="text-gray-500 dark:text-dark-secondary">[Media not available]</span>';
        const type = media.type ? media.type.toLowerCase() : "";
        switch (type) {
          case "photo":
          case "waifu":
          case "image":
            mediaElement = `<img src="${mediaUrl}" class="max-w-full h-auto rounded-lg mt-2 mb-2 elevation-1" alt="Shared image" loading="lazy" onerror="this.onerror=null;this.src='/placeholder.svg';this.alt='Image failed to load';">`;
            break;
          case "video":
            const videoExt = mediaUrl.split(".").pop().toLowerCase();
            mediaElement = `<div class="video-container mt-2 mb-2">
                              <video controls class="rounded-lg max-w-full elevation-1">
                                <source src="${mediaUrl}" type="video/${videoExt}">
                                Your browser does not support the video tag.
                              </video>
                            </div>`;
            break;
          case "audio":
            const audioExt = mediaUrl.split(".").pop().toLowerCase();
            mediaElement = `<div class="audio-container mt-2 mb-2">
                              <audio controls class="w-full elevation-1">
                                <source src="${mediaUrl}" type="audio/${audioExt}">
                                Your browser does not support the audio tag.
                              </audio>
                            </div>`;
            break;
          case "document":
            mediaElement = `<a href="${mediaUrl}" target="_blank" rel="noopener noreferrer" class="flex items-center p-3 bg-gray-100 dark:bg-dark-input rounded-lg hover:bg-gray-200 dark:hover:bg-dark-border transition-colors elevation-1">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-primary-600 dark:text-primary-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                              </svg>
                              <span>Download File</span>
                              <span class="sr-only">(opens in new tab)</span>
                            </a>`;
            break;
          case "sticker":
            mediaElement = `<img src="${mediaUrl}" class="max-w-[150px] h-auto mt-2 mb-2 elevation-1" alt="Sticker" loading="lazy" onerror="this.onerror=null;this.src='/placeholder.svg';this.alt='Sticker failed to load';">`;
            break;
          default:
            mediaElement = `<span class="text-gray-500 dark:text-dark-secondary">[Unsupported media type]</span>`;
        }
        if (media.options && media.options.caption) {
          mediaElement += `<div class="media-caption text-sm text-gray-500 dark:text-dark-secondary mt-1">
                             ${processLongWords(media.options.caption)}
                           </div>`;
        }
        return mediaElement;
      };

      // Save and load chat history uniquely for the logged in session
      const saveMessageToHistory = (content, isUser) => {
        try {
          let history = JSON.parse(localStorage.getItem(chatHistoryKey)) || [];
          history.push({ id: Date.now().toString(), content, isUser, timestamp: Date.now() });
          if (history.length > 100) history = history.slice(-100);
          localStorage.setItem(chatHistoryKey, JSON.stringify(history));
        } catch (error) {
          console.error("Error saving message to history:", error);
        }
      };

      const loadChatHistory = () => {
        try {
          const history = JSON.parse(localStorage.getItem(chatHistoryKey)) || [];
          chatArea.innerHTML = "";
          chatArea.setAttribute("role", "list");
          chatArea.setAttribute("aria-label", "Chat messages");

          if (history.length === 0) {
            addMessage("👋 Welcome to Wataru Chat! How can I assist you today?");
          } else {
            history.forEach((message) => addMessage(message.content, message.isUser, false));
          }
        } catch (error) {
          console.error("Error loading chat history:", error);
          chatArea.innerHTML = "";
          chatArea.setAttribute("role", "list");
          chatArea.setAttribute("aria-label", "Chat messages");
          addMessage("👋 Welcome to Wataru Chat! How can I assist you today?");
        }
      };

      const clearChat = () => {
        localStorage.removeItem(chatHistoryKey);
        chatArea.innerHTML = "";
        chatArea.setAttribute("role", "list");
        chatArea.setAttribute("aria-label", "Chat messages");
        addMessage("Chat history cleared. How can I assist you today?");
        announceToScreenReader("Chat history cleared");
      };

      const sendCommand = async (command) => {
        if (!command.trim()) return;
        addMessage(command, true);
        commandInput.value = "";
        commandInput.style.height = "auto";
        sendCommandButton.classList.add("hidden");
        try {
          if (!navigator.onLine) throw new Error("You are currently offline");
          const session = localStorage.getItem("userSession");
          const { data } = await axios.get("/api/command", {
            params: { body: command, chatId: conversationId, session },
            timeout: 30000
          });
          if (!data.fail) {
            if (typeof data.message === "object" && data.message.type === "clear")
              clearChat();
            else addMessage(data.message);
          } else {
            addMessage(`Error: ${data.message}`);
          }
        } catch (error) {
          console.error("Error processing command:", error);
          if (error.message === "You are currently offline")
            addMessage("⚠️ You're offline. Please check your internet connection and try again.");
          else if (error.response && error.response.status === 401) {
            addMessage("⚠️ Your session has expired. Please log in again.");
            setTimeout(() => {
              localStorage.removeItem("userSession");
              location.reload();
            }, 2000);
          }
          else if (error.response)
            addMessage(`⚠️ Server error: ${error.response.status} ${error.response.statusText}`);
          else addMessage("⚠️ Sorry, there was an error processing your request. Please try again later.");
        }
      };

      const adjustTextareaHeight = () => {
        commandInput.style.height = "auto";
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const maxHeight = isMobile ? 100 : 150;
        const newHeight = Math.min(commandInput.scrollHeight, maxHeight);
        commandInput.style.height = newHeight + "px";
      };

      const openLightbox = (imgSrc) => {
        lightboxImg.src = imgSrc;
        lightboxImg.alt = "Enlarged image";
        lightbox.classList.add("active");
        document.body.style.overflow = "hidden";
        setTimeout(() => lightboxClose.focus(), 100);
        lightboxImg.onerror = function() {
          this.onerror = null;
          this.src = '/placeholder.svg';
          this.alt = 'Image failed to load';
        };
      };

      const closeLightbox = () => {
        lightbox.classList.remove("active");
        document.body.style.overflow = "";
        setTimeout(() => { lightboxImg.src = ""; }, 300);
        commandInput.focus();
      };

      const updateConnectionStatus = () => {
        if (!navigator.onLine) {
          connectionStatus.style.transform = "translateY(0)";
          connectionStatus.setAttribute("aria-hidden", "false");
        } else {
          connectionStatus.style.transform = "translateY(-100%)";
          connectionStatus.setAttribute("aria-hidden", "true");
        }
      };

      /* ---------------------
       * Login & Account Handling
       * --------------------- */
      // After a successful login, we set conversationId based on the user's session token
      // and build a unique key for storing chat history.
      const initializeChat = () => {
        loginContainer.classList.add("hidden");
        createAccountContainer.classList.add("hidden");
        chatContainer.classList.remove("hidden");
        chatContainer.classList.add("flex");
        chatHeader.classList.remove("hidden");
        // Set conversationId as the session token and use it for the chat history key
        conversationId = localStorage.getItem("userSession");
        chatHistoryKey = "chat_" + conversationId;
        adjustTextareaHeight();
        loadChatHistory();
        commandInput.focus();
        updateConnectionStatus();
      };

      const attemptLogin = async (username, password) => {
        try {
          loginButtonText.classList.add("hidden");
          loginButtonLoading.classList.remove("hidden");

          const response = await axios.post("/api/login", { username, password });

          loginButtonText.classList.remove("hidden");
          loginButtonLoading.classList.add("hidden");

          if (!response.data.fail && response.data.session) {
            localStorage.setItem("userSession", response.data.session);
            return true;
          }
          return false;
        } catch (error) {
          console.error("Login error:", error);
          loginButtonText.classList.remove("hidden");
          loginButtonLoading.classList.add("hidden");
          return false;
        }
      };

      const attemptCreateAccount = async (username, password, email) => {
        try {
          createButtonText.classList.add("hidden");
          createButtonLoading.classList.remove("hidden");

          const response = await axios.post("/api/create-account", { username, password, email });

          createButtonText.classList.remove("hidden");
          createButtonLoading.classList.add("hidden");

          return !response.data.fail;
        } catch (error) {
          console.error("Create account error:", error);
          createButtonText.classList.remove("hidden");
          createButtonLoading.classList.add("hidden");
          return false;
        }
      };

      // Toggle password visibility
      document.querySelectorAll(".password-toggle").forEach(toggle => {
        toggle.addEventListener("click", () => {
          const input = toggle.parentElement.querySelector("input");
          const type = input.getAttribute("type") === "password" ? "text" : "password";
          input.setAttribute("type", type);

          if (type === "text") {
            toggle.setAttribute("aria-label", "Hide password");
            toggle.innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path fill-rule="evenodd" d="M3.707 2.293a1 1 0 00-1.414 1.414l14 14a1 1 0 001.414-1.414l-1.473-1.473A10.014 10.014 0 0019.542 10C18.268 5.943 14.478 3 10 3a9.958 9.958 0 00-4.512 1.074l-1.78-1.781zm4.261 4.26l1.514 1.515a2.003 2.003 0 012.45 2.45l1.514 1.514a4 4 0 00-5.478-5.478z" clip-rule="evenodd" />
                <path d="M12.454 16.697L9.75 13.992a4 4 0 01-3.742-3.741L2.335 6.578A9.98 9.98 0 00.458 10c1.274 4.057 5.065 7 9.542 7 .847 0 1.669-.105 2.454-.303z" />
              </svg>
            `;
          } else {
            toggle.setAttribute("aria-label", "Show password");
            toggle.innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
              </svg>
            `;
          }
        });
      });

      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        loginError.classList.add("hidden");
        const username = usernameInput.value.trim();
        const password = passwordInput.value;

        if (!username || !password) {
          loginError.textContent = "Please enter both username and password";
          loginError.classList.remove("hidden");
          return;
        }

        const success = await attemptLogin(username, password);
        if (success) {
          initializeChat();
        } else {
          loginError.textContent = "Invalid username or password";
          loginError.classList.remove("hidden");
          usernameInput.focus();
        }
      });

      createAccountForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        createAccountError.classList.add("hidden");
        createAccountSuccess.classList.add("hidden");

        const username = newUsernameInput.value.trim();
        const password = newPasswordInput.value;
        const email = newEmailInput.value.trim();

        if (!username || !password) {
          createAccountError.textContent = "Please enter both username and password";
          createAccountError.classList.remove("hidden");
          newUsernameInput.focus();
          return;
        }

        if (password.length < 6) {
          createAccountError.textContent = "Password must be at least 6 characters";
          createAccountError.classList.remove("hidden");
          newPasswordInput.focus();
          return;
        }

        const success = await attemptCreateAccount(username, password, email);
        if (success) {
          createAccountSuccess.classList.remove("hidden");
          setTimeout(async () => {
            const loginSuccess = await attemptLogin(username, password);
            if (loginSuccess) {
              initializeChat();
            } else {
              createAccountSuccess.classList.add("hidden");
              createAccountError.textContent = "Account created but login failed. Please try logging in manually.";
              createAccountError.classList.remove("hidden");
            }
          }, 1500);
        } else {
          createAccountError.textContent = "Username already exists or account creation failed";
          createAccountError.classList.remove("hidden");
          newUsernameInput.focus();
        }
      });

      showCreateAccountLink.addEventListener("click", (e) => {
        e.preventDefault();
        loginContainer.classList.add("hidden");
        createAccountContainer.classList.remove("hidden");
        newUsernameInput.focus();
        loginError.classList.add("hidden");
        createAccountError.classList.add("hidden");
        createAccountSuccess.classList.add("hidden");
      });

      showLoginLink.addEventListener("click", (e) => {
        e.preventDefault();
        createAccountContainer.classList.add("hidden");
        loginContainer.classList.remove("hidden");
        usernameInput.focus();
        loginError.classList.add("hidden");
        createAccountError.classList.add("hidden");
        createAccountSuccess.classList.add("hidden");
      });

      // Drop-down menu functionality
      menuButton.addEventListener("click", (e) => {
        e.stopPropagation();
        dropdownMenu.classList.toggle("show");
        const isExpanded = dropdownMenu.classList.contains("show");
        menuButton.setAttribute("aria-expanded", isExpanded ? "true" : "false");
      });

      document.addEventListener("click", (e) => {
        if (!dropdownMenu.contains(e.target) && !menuButton.contains(e.target)) {
          dropdownMenu.classList.remove("show");
          menuButton.setAttribute("aria-expanded", "false");
        }
      });

      themeToggleMenu.addEventListener("click", () => {
        toggleTheme();
        dropdownMenu.classList.remove("show");
        menuButton.setAttribute("aria-expanded", "false");
        announceToScreenReader(`Switched to ${document.documentElement.classList.contains("dark") ? "dark" : "light"} mode`);
      });

      clearChatMenu.addEventListener("click", () => {
        clearChat();
        dropdownMenu.classList.remove("show");
        menuButton.setAttribute("aria-expanded", "false");
      });

      logoutMenu.addEventListener("click", () => {
        localStorage.removeItem("userSession");
        location.reload();
      });

      // Chat Interface Events
      sendCommandButton.addEventListener("click", () => {
        const command = commandInput.value.trim();
        if (command) sendCommand(command);
      });

      commandInput.addEventListener("input", () => {
        adjustTextareaHeight();
        sendCommandButton.classList.toggle("hidden", commandInput.value.trim() === "");
      });

      commandInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          const command = commandInput.value.trim();
          if (command) sendCommand(command);
        }
      });

      lightboxClose.addEventListener("click", closeLightbox);
      lightbox.addEventListener("click", (e) => { if (e.target === lightbox) closeLightbox(); });
      document.addEventListener("keydown", (e) => { if (e.key === "Escape" && lightbox.classList.contains("active")) closeLightbox(); });
      window.addEventListener("resize", adjustTextareaHeight);

      window.addEventListener("online", () => { 
        updateConnectionStatus();
        addMessage("✅ You're back online!"); 
      });

      window.addEventListener("offline", () => { 
        updateConnectionStatus();
        addMessage("⚠️ You're offline. Please check your internet connection."); 
      });

      // Accessibility keyboard navigation for dropdown menu
      document.addEventListener("keydown", (e) => {
        if (e.key === "Tab" && dropdownMenu.classList.contains("show")) {
          const focusableElements = dropdownMenu.querySelectorAll("button");
          const firstElement = focusableElements[0];
          const lastElement = focusableElements[focusableElements.length - 1];

          if (e.shiftKey && document.activeElement === firstElement) {
            e.preventDefault();
            menuButton.focus();
          } else if (!e.shiftKey && document.activeElement === lastElement) {
            e.preventDefault();
            dropdownMenu.classList.remove("show");
            menuButton.setAttribute("aria-expanded", "false");
          }
        }
      });

      initTheme();
      if (localStorage.getItem("userSession")) {
        // If a session already exists, initialize chat with its unique chat history.
        initializeChat();
      } else {
        loginContainer.classList.remove("hidden");
        usernameInput.focus();
      }

      // Global error and performance monitoring
      window.addEventListener("error", (event) => {
        console.error("Unhandled error:", event.error);
      });

      if ('performance' in window && 'PerformanceObserver' in window) {
        const observer = new PerformanceObserver((list) => {
          for (const entry of list.getEntries()) {
            console.log(`${entry.name}: ${entry.startTime}`, entry);
          }
        });
        observer.observe({ entryTypes: ['largest-contentful-paint', 'first-input', 'layout-shift'] });
      }
    });
  </script>
</body>
</html>
